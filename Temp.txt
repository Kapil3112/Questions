@WITH base_monthly_features AS (
SELECT
PTY_ID, AGRMNT_ID, txn_month, txn_year,
--CASH_OUTFLOW
SUM (CASE WHEN CRT_DBT_IND = 'Debit'
AND OW_FINAL CATEGORY _1 l= 'Exclusion' THEN EVENT_AM ELSE 0 END)
AS CASH_OUTFLOW,
- - CASH_OUTFLOW_COUNT
COUNT (CASE WHEN CRT_DBT_IND = 'Debit' AND OW_FINAL_CATEGORY_1 != 'Exclusion'
AS CASH_OUTFLOW_COUNT,
- - CORPORATION_TAX
SUM(CASE WHEN CRT_DBT_IND = 'Debit'
AND OW_FINAL_CATEGORY_2 = 'Taxes - Corporation' THEN EVENT_AM ELSE 0 END)
AS CORPORATION_TAX,
--TAX_EXPENSES
SUM(CASE WHEN CRT_DBT_IND = 'Debit*
AND OW_FINAL_CATEGORY_1 = 'Taxes' THEN EVENT_AM ELSE Â® END)
AS TAX_EXPENSES,
- UTILITY_EXPENSES
SUM(CASE WHEN CRT_DBT_IND = 'Debit'
AND OW_FINAL_CATEGORY_1 = 'Utilities' THEN EVENT_AM ELSE 0 END)
AS UTILITY_EXPENSES,
-- GROSS_CASH_INFLOW
SUM(CASE WHEN CRT_DBT_IND = 'Credit'
AND OW_FINAL_CATEGORY_1 l= 'Exclusion' THEN EVENT_AM ELSE 0 END)
AS GROSS_CASH_INFLOW,
- LOANS_CREDIT
SUM(CASE WHEN CRT_DBT_IND = 'Credit'
AND OW_FINAL_CATEGORY_1 = 'Loans' THEN EVENT_AM ELSE O END)
AS LOANS_CREDIT,
- -TAXES_CREDIT_CREDIT
SUM(CASE WHEN CRT_DBT_IND = 'Credit'
AND OW_FINAL_CATEGORY _2 = 'Taxes - Credit' THEN EVENT_AM ELSE O END)
AS TAXES_CREDIT_CREDIT,
-DIRECTOR_PAYMENT_CREDIT
SUM(CASE WHEN CRT_DBT_IND = 'Credit'
AND OW_FINAL_CATEGORY_1 IN('Director Payment', 'Director Payment Secondary') TH AS DIRECTOR_PAYMENT_CREDIT,
-CASH_WITHDRAWALS
SUM(CASE WHEN CRT_DBT_IND = 'Debit'
AND OW_FINAL_CATEGORY_1 = 'Cash Withdrawals' THEN EVENT_AM ELSE 0 END)
AS CASH_WITHDRAWALS,
-INTRA_GROUP_IN
SUM(CASE WHEN CRT_DBT_IND = 'Credit'
AND OM_FINAL CATEGORY_1 = "InIna-group Transfer' THEN EVENT_AM ELSE O END)
AS INTRA_GROUP_IN,
-VAT
SUM(CASE WHEN CRT_DBT_IND = 'Debit'
AND OW_FINAL_CATEGORY_2 = 'Taxes - VAT' THEN EVENT_AM ELSE 0 END)
AS VAT,
- -CASH_FLOW_GROSS
SUM(CASE WHEN OW_FINAL_CATEGORY_1 I= 'Exclusions'
THEN EVENT_AM ELSE 0 END)
AS CASH_FLOW_GROSS,
--DEBIT_COUNT
COUNT (CASE WHEN CRT_DBT_IND = 'Debit' AND OW_FINAL_CATEGORY_1 I= 'Exclusions' THE
AS DEBIT_COUNT,
- -INVOICE_FINANCE
SUM (CASE WHEN CRT_DBT_IND = 'Credit'
AND OW_FINAL_CATEGORY_1 = 'Invoice Finance' THEN EVENT_AM ELSE NULL END)
AS INVOICE_FINANCE,
- - INTRA_GROUP_OUT
SUM(CASE WHEN CRT_DBT_IND = 'Debit'
AND OW_FINAL_CATEGORY_1 = 'Intra-group Transfer' THEN EVENT_AM ELSE NULL END)
AS INTRA_GROUP_OUT
FROM { source (' sre_schema', 'tesowcurated") ]} GROUP BY PTY_ID, txn_year, txn_month
